name: Deploy to Local PC

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Security Scanning", "Test & Coverage"]
    types:
      - completed
    branches: [main]

jobs:
  deploy-local:
    name: Deploy to Local PC
    runs-on: self-hosted
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create backend .env.production
        run: |
          cd C:\Users\samuel\Documents\rattrapage\backend
          @"
          MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_MODE=sandbox
          "@ | Out-File -FilePath .env.production -Encoding UTF8
      
      - name: Create frontend .env.production
        run: |
          cd C:\Users\samuel\Documents\rattrapage\trinity
          @"
          NEXT_PUBLIC_API_URL=http://localhost:4000
          "@ | Out-File -FilePath .env.production -Encoding UTF8
      
      - name: Stop existing containers
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose -f docker-compose.prod.yml down
        continue-on-error: true
      
      - name: Pull latest images
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose -f docker-compose.prod.yml pull
        continue-on-error: true
      
      - name: Debug - Check secrets availability
        env:
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET: ${{ secrets.PAYPAL_CLIENT_SECRET }}
        run: |
          Write-Host "=== Checking Secrets Availability ==="
          if ([string]::IsNullOrEmpty($env:MONGO_PASSWORD)) { 
            Write-Host "❌ MONGO_PASSWORD is EMPTY or NULL" 
          } else { 
            Write-Host "✅ MONGO_PASSWORD is set (length: $($env:MONGO_PASSWORD.Length) chars, starts with: $($env:MONGO_PASSWORD.Substring(0, [Math]::Min(3, $env:MONGO_PASSWORD.Length)))...)" 
          }
          if ([string]::IsNullOrEmpty($env:JWT_SECRET)) { 
            Write-Host "❌ JWT_SECRET is EMPTY or NULL" 
          } else { 
            Write-Host "✅ JWT_SECRET is set (length: $($env:JWT_SECRET.Length) chars)" 
          }
          if ([string]::IsNullOrEmpty($env:PAYPAL_CLIENT_ID)) { 
            Write-Host "❌ PAYPAL_CLIENT_ID is EMPTY or NULL" 
          } else { 
            Write-Host "✅ PAYPAL_CLIENT_ID is set (length: $($env:PAYPAL_CLIENT_ID.Length) chars)" 
          }
          if ([string]::IsNullOrEmpty($env:PAYPAL_CLIENT_SECRET)) { 
            Write-Host "❌ PAYPAL_CLIENT_SECRET is EMPTY or NULL" 
          } else { 
            Write-Host "✅ PAYPAL_CLIENT_SECRET is set (length: $($env:PAYPAL_CLIENT_SECRET.Length) chars)" 
          }
      
      - name: Build and start containers
        env:
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET: ${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_MODE: sandbox
          API_URL: http://localhost:4000
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          Write-Host "=== Setting environment variables for docker-compose ==="
          $env:MONGO_PASSWORD = "$env:MONGO_PASSWORD"
          $env:JWT_SECRET = "$env:JWT_SECRET"
          $env:PAYPAL_CLIENT_ID = "$env:PAYPAL_CLIENT_ID"
          $env:PAYPAL_CLIENT_SECRET = "$env:PAYPAL_CLIENT_SECRET"
          $env:PAYPAL_MODE = "$env:PAYPAL_MODE"
          $env:API_URL = "$env:API_URL"
          
          Write-Host "=== Running docker-compose config to verify variable substitution ==="
          docker-compose -f docker-compose.prod.yml config | Select-String -Pattern "MONGO_INITDB_ROOT_PASSWORD" -Context 2,2
          
          Write-Host "=== Starting containers ==="
          docker-compose -f docker-compose.prod.yml up -d --build
      
      - name: Wait for containers to start
        run: |
          Write-Host "Waiting 10 seconds for containers to initialize..."
          Start-Sleep -Seconds 10
      
      - name: Check MongoDB container logs
        run: |
          Write-Host "=== MongoDB Container Logs (last 30 lines) ==="
          docker logs trinity_mongo_prod --tail 30
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          if (Test-Path .env) { Remove-Item .env -Force }
          if (Test-Path backend\.env.production) { Remove-Item backend\.env.production -Force }
      
      - name: Clean up old images
        run: docker image prune -f
        continue-on-error: true
      
      - name: Show running containers
        run: docker ps
      
      - name: Show logs
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose logs --tail=50
