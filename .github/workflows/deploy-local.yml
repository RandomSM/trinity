name: Deploy to Local PC

on:
  push:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  deploy-local:
    name: Deploy to Local PC
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Stop existing containers
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose down
        continue-on-error: true
      
      - name: Pull latest images (if using registry)
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose pull
        continue-on-error: true
      
      - name: Build and start containers
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB: eshop
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET: ${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_MODE: sandbox
          OPENFOODFACTS_API: https://world.openfoodfacts.org/api/v0
          NEXT_PUBLIC_API_URL: http://localhost:4000
          NEXT_PUBLIC_PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PORT: 4000
          NODE_ENV: production
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose up -d --build
      
      - name: Clean up old images
        run: docker image prune -f
        continue-on-error: true
      
      - name: Show running containers
        run: docker ps
      
      - name: Show logs
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose logs --tail=50
