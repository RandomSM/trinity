name: Deploy to Local PC

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Security Scanning", "Test & Coverage"]
    types:
      - completed
    branches: [main]

jobs:
  deploy-local:
    name: Deploy to Local PC
    runs-on: self-hosted
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create backend .env.production
        run: |
          cd C:\Users\samuel\Documents\rattrapage\backend
          @"
          MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_MODE=sandbox
          "@ | Out-File -FilePath .env.production -Encoding UTF8
      
      - name: Create frontend .env.production
        run: |
          cd C:\Users\samuel\Documents\rattrapage\trinity
          @"
          NEXT_PUBLIC_API_URL=http://localhost:4000
          "@ | Out-File -FilePath .env.production -Encoding UTF8
      
      - name: Stop existing containers
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose -f docker-compose.prod.yml down
        continue-on-error: true
      
      - name: Pull latest images (if using registry)
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose -f docker-compose.prod.yml pull
        continue-on-error: true
      
      - name: Build and start containers
        env:
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET: ${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_MODE: sandbox
          API_URL: http://localhost:4000
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          $env:MONGO_PASSWORD = "$env:MONGO_PASSWORD"
          $env:JWT_SECRET = "$env:JWT_SECRET"
          $env:PAYPAL_CLIENT_ID = "$env:PAYPAL_CLIENT_ID"
          $env:PAYPAL_CLIENT_SECRET = "$env:PAYPAL_CLIENT_SECRET"
          $env:PAYPAL_MODE = "$env:PAYPAL_MODE"
          $env:API_URL = "$env:API_URL"
          docker-compose -f docker-compose.prod.yml up -d --build
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          if (Test-Path .env) { Remove-Item .env -Force }
          if (Test-Path backend\.env.production) { Remove-Item backend\.env.production -Force }
      
      - name: Clean up old images
        run: docker image prune -f
        continue-on-error: true
      
      - name: Show running containers
        run: docker ps
      
      - name: Show logs
        run: |
          cd C:\Users\samuel\Documents\rattrapage
          docker-compose logs --tail=50
